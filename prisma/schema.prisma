generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  password      String?
  name          String?
  plan          Plan           @default(SOLO)
  stripeCustomerId String?     @unique
  stripeSubscriptionId String? @unique
  subscriptionStatus String?   // active, canceled, past_due, trialing
  trialEndsAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  conversations Conversation[]
  messages      Message[]
  jobContexts   JobContext[]
  projects      Project[]
  jobs          Job[]
  payments      Payment[]
  templates     Template[]
  riskFlags     RiskFlag[]
  companySettings CompanySettings?
  invoices      Invoice[]
}

model Conversation {
  id            String    @id @default(cuid())
  userId        String
  issueType     IssueType
  jobContextId  String?
  projectId     String?
  jobId         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobContext    JobContext? @relation(fields: [jobContextId], references: [id])
  project       Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  job           Job?      @relation(fields: [jobId], references: [id], onDelete: SetNull)
  messages      Message[]

  @@index([userId])
  @@index([createdAt])
  @@index([projectId])
  @@index([jobId])
}

model Message {
  id              String       @id @default(cuid())
  conversationId  String
  userId          String
  role            Role
  content         String
  createdAt       DateTime     @default(now())

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

model JobContext {
  id            String         @id @default(cuid())
  userId        String
  name          String
  type          String
  value         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@index([userId])
}

enum Plan {
  SOLO
  SMALL_FIRM
  PRO
}

enum IssueType {
  PAYMENT
  EXTRAS
  CUSTOMER
  OVERRUN
  PRICING
  DISPUTE
  OTHER
}

enum Role {
  USER
  ASSISTANT
}

model Project {
  id            String         @id @default(cuid())
  userId        String
  name          String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@index([userId])
  @@index([createdAt])
}

model Job {
  id                  String      @id @default(cuid())
  userId              String
  name                String
  customerName        String?
  stage               JobStage    @default(QUOTE)
  value               Float       @default(0)
  invoicedAmount      Float       @default(0)
  paidAmount          Float       @default(0)
  outstandingAmount   Float       @default(0)
  overdueAmount       Float       @default(0)
  lastPaymentDate     DateTime?
  nextPaymentDue      DateTime?
  notes               String?
  riskLevel           RiskLevel   @default(LOW)
  needsAttentionToday Boolean     @default(false)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  user                User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments            Payment[]
  riskFlags           RiskFlag[]
  templates           Template[]
  conversations       Conversation[]
  invoices            Invoice[]

  @@index([userId])
  @@index([stage])
  @@index([needsAttentionToday])
  @@index([createdAt])
}

model Payment {
  id             String        @id @default(cuid())
  jobId          String
  userId         String
  amount         Float
  type           PaymentType   @default(STAGE_PAYMENT)
  status         PaymentStatus @default(PENDING)
  dueDate        DateTime?
  paidDate       DateTime?
  invoiceNumber  String?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  job            Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

model Template {
  id          String       @id @default(cuid())
  userId      String
  jobId       String?
  title       String
  content     String
  category    TemplateCategory
  issueType   IssueType?
  lastUsed    DateTime?
  timesUsed   Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  job         Job?         @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([jobId])
  @@index([category])
  @@index([lastUsed])
}

model RiskFlag {
  id          String       @id @default(cuid())
  jobId       String
  userId      String
  type        RiskFlagType
  severity    RiskLevel
  message     String
  dismissed   Boolean      @default(false)
  dismissedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  job         Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([userId])
  @@index([dismissed])
  @@index([severity])
}

enum JobStage {
  QUOTE
  ACCEPTED
  STARTED
  IN_PROGRESS
  WAITING_PAYMENT
  COMPLETED
  CANCELLED
}

enum PaymentType {
  DEPOSIT
  STAGE_PAYMENT
  FINAL
  VARIATION
  MATERIALS
}

enum PaymentStatus {
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum TemplateCategory {
  PAYMENT_CHASE
  VARIATION_APPROVAL
  CUSTOMER_UPDATE
  QUOTE_FOLLOWUP
  COMPLETION_NOTICE
  DISPUTE_RESOLUTION
  OTHER
}

enum RiskFlagType {
  VARIATION_UNSIGNED
  PAYMENT_OVERDUE
  DECISION_DELAY
  WORK_WITHOUT_APPROVAL
  CUSTOMER_BEHAVIOR_PATTERN
  INVOICE_UNPAID
  MATERIALS_PAID_NO_PAYMENT
  OTHER
}

model CompanySettings {
  id                String    @id @default(cuid())
  userId            String    @unique
  companyName       String
  addressLine1      String?
  addressLine2      String?
  city              String?
  postcode          String?
  phone             String?
  email             String?
  vatNumber         String?
  registrationNumber String?
  bankName          String?
  accountNumber     String?
  sortCode          String?
  logo              String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Invoice {
  id                String            @id @default(cuid())
  userId            String
  jobId             String?
  invoiceNumber     String
  status            InvoiceStatus     @default(DRAFT)
  issueDate         DateTime          @default(now())
  dueDate           DateTime?
  customerName      String
  customerEmail     String?
  customerPhone     String?
  customerAddress   String?
  subtotal          Float             @default(0)
  vatAmount         Float             @default(0)
  total             Float             @default(0)
  notes             String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  job               Job?              @relation(fields: [jobId], references: [id], onDelete: SetNull)
  lineItems         InvoiceLineItem[]

  @@index([userId])
  @@index([jobId])
  @@index([invoiceNumber])
  @@index([status])
}

model InvoiceLineItem {
  id          String   @id @default(cuid())
  invoiceId   String
  title       String
  description String?
  quantity    Float    @default(1)
  unitPrice   Float
  vatApplicable Boolean @default(true)
  vatRate     Float    @default(20)
  subtotal    Float
  vatAmount   Float
  total       Float
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([order])
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}
